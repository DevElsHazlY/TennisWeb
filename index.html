<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة تنس ثنائية الأبعاد - مع نظام الأونلاين</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            overflow: hidden;
            position: relative;
        }
        
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></svg>');
            background-size: 30px 30px;
            z-index: -1;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* شاشة تسجيل الدخول */
        .login-screen, .start-screen, .game-container, .online-screen {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(0);
            opacity: 1;
            transition: all 0.5s ease;
        }
        
        .hidden {
            display: none;
            opacity: 0;
            transform: translateY(-20px);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }
        
        h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #4fc3f7;
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #b3e5fc;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        input:focus {
            outline: none;
            border-color: #4fc3f7;
            background: rgba(79, 195, 247, 0.1);
        }
        
        button {
            background: linear-gradient(45deg, #ff9800, #ff5722);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            margin: 10px 5px;
            width: 100%;
            max-width: 250px;
            box-shadow: 0 5px 15px rgba(255, 87, 34, 0.4);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 87, 34, 0.6);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #2196f3, #1976d2);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.6);
        }
        
        .game-modes {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }
        
        .mode-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .mode-btn h3 {
            color: #ffcc00;
            margin-bottom: 10px;
        }
        
        .mode-btn p {
            color: #b3e5fc;
            font-size: 0.9rem;
        }
        
        /* لعبة التنس */
        .game-container {
            max-width: 800px;
            padding: 20px;
        }
        
        canvas {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            display: block;
            margin: 0 auto;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .scores {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            font-size: 1.5rem;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }
        
        .player-name {
            color: #ffcc00;
        }
        
        .ai-name {
            color: #4fc3f7;
        }
        
        .game-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        /* رسالة الفوز */
        .win-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        
        .win-message.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .win-message h2 {
            font-size: 4rem;
            margin-bottom: 30px;
            color: #ffcc00;
            text-shadow: 0 0 20px rgba(255, 204, 0, 0.8);
        }
        
        .win-message p {
            font-size: 2rem;
            margin-bottom: 30px;
        }
        
        /* شاشة الأونلاين */
        .online-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .room-id {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffcc00;
            margin: 10px 0;
            word-break: break-all;
        }
        
        .players {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }
        
        .player {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            min-width: 120px;
        }
        
        .player.ready {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
        }
        
        /* تصميم متجاوب */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .login-screen, .start-screen, .game-container, .online-screen {
                padding: 20px;
                width: 95%;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .scores {
                font-size: 1.2rem;
            }
            
            button {
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            .win-message h2 {
                font-size: 2.5rem;
            }
            
            .win-message p {
                font-size: 1.5rem;
            }
        }
        
        /* رسائل التحميل والحالة */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .status-message {
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #ffcdd2;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        /* أزرار التحكم باللمس */
        .touch-btn {
            position: fixed;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            z-index: 999;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #upBtn { 
            bottom: 120px; 
            left: 20px; 
        }
        
        #downBtn { 
            bottom: 50px; 
            left: 20px; 
        }
        
        @media (max-width: 768px) {
            .touch-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            #upBtn { 
                bottom: 100px; 
                left: 15px; 
            }
            
            #downBtn { 
                bottom: 40px; 
                left: 15px; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- شاشة تسجيل الدخول -->
        <div id="loginScreen" class="login-screen">
            <h1>تسجيل الدخول</h1>
            <div class="form-group">
                <label for="username">اسم المستخدم:</label>
                <input type="text" id="username" placeholder="أدخل اسم المستخدم">
            </div>
            <div class="form-group">
                <label for="password">كلمة المرور:</label>
                <input type="password" id="password" placeholder="أدخل كلمة المرور">
            </div>
            <button id="loginBtn">تسجيل الدخول</button>
            <button class="btn-secondary" id="guestBtn">الدخول كضيف</button>
        </div>
        
        <!-- شاشة البداية -->
        <div id="startScreen" class="start-screen hidden">
            <h1>لعبة تنس ثنائية الأبعاد</h1>
            <h2>اختر نمط اللعب</h2>
            
            <div class="game-modes">
                <div class="mode-btn" data-mode="single">
                    <h3>اللعب الفردي</h3>
                    <p>العب ضد الذكاء الاصطناعي</p>
                </div>
                <div class="mode-btn" data-mode="multi">
                    <h3>اللعب الجماعي</h3>
                    <p>العب مع صديقك على نفس الجهاز</p>
                </div>
                <div class="mode-btn" data-mode="ai">
                    <h3>الذكاء الاصطناعي</h3>
                    <p>شاهد الذكاء الاصطناعي يلعب ضد نفسه</p>
                </div>
                <div class="mode-btn" data-mode="online">
                    <h3>الأونلاين</h3>
                    <p>العب مع لاعب آخر عبر الإنترنت</p>
                </div>
            </div>
            
            <button id="backToLoginBtn" class="btn-secondary">العودة لتسجيل الدخول</button>
        </div>
        
        <!-- شاشة الأونلاين -->
        <div id="onlineScreen" class="online-screen hidden">
            <h1>اللعب عبر الإنترنت</h1>
            
            <div id="onlineMenu">
                <div class="form-group">
                    <label for="roomId">معرف الغرفة:</label>
                    <input type="text" id="roomId" placeholder="أدخل معرف الغرفة للانضمام">
                </div>
                <button id="createRoomBtn">إنشاء غرفة جديدة</button>
                <button id="joinRoomBtn">الانضمام إلى غرفة</button>
                <div id="onlineStatusMessage" class="status-message hidden">
                    <span class="loading"></span> <span id="statusText">جارٍ المعالجة...</span>
                </div>
                <div id="errorMessage" class="error-message hidden"></div>
            </div>
            
            <div id="roomInfo" class="hidden">
                <div class="online-info">
                    <h3>معلومات الغرفة</h3>
                    <p>معرف الغرفة: <span id="roomIdDisplay" class="room-id"></span></p>
                    <p>حالة الغرفة: <span id="roomStatus">في انتظار اللاعب الثاني</span></p>
                    
                    <div class="players">
                        <div id="hostPlayer" class="player">
                            <h4>المضيف</h4>
                            <p id="hostName">...</p>
                            <p id="hostStatus">جاري الاتصال...</p>
                        </div>
                        <div id="guestPlayer" class="player">
                            <h4>الضيف</h4>
                            <p id="guestName">...</p>
                            <p id="guestStatus">في انتظار اللاعب</p>
                        </div>
                    </div>
                </div>
                
                <button id="startOnlineGameBtn" class="hidden">بدء اللعبة</button>
                <button id="leaveRoomBtn" class="btn-secondary">مغادرة الغرفة</button>
            </div>
            
            <button id="backToStartOnlineBtn" class="btn-secondary">العودة للقائمة</button>
        </div>
        
        <!-- منطقة اللعبة -->
        <div id="gameContainer" class="game-container hidden">
            <div class="scores">
                <div class="player-score">
                    <span class="player-name" id="playerName">اللاعب</span>: 
                    <span id="leftScore">0</span>
                </div>
                <div class="ai-score">
                    <span class="ai-name" id="opponentName">الخصم</span>: 
                    <span id="rightScore">0</span>
                </div>
            </div>
            
            <canvas id="gameCanvas" width="800" height="400"></canvas>
            
            <div class="controls">
                <button id="restartBtn">إعادة اللعبة</button>
                <button id="backToStartBtn" class="btn-secondary">العودة للقائمة</button>
            </div>
            
            <div class="game-info">
                <p><strong>التحكم:</strong> استخدم مفاتيح الأسهم (▲ ▼) للتحكم بالمضرب الأيسر</p>
                <p>في وضع اللعب الجماعي: استخدم مفاتيح (W, S) للتحكم بالمضرب الأيمن</p>
                <p id="onlineStatus" class="hidden">متصل بالإنترنت - <span id="ping">0</span>ms</p>
                <p id="connectionStatus" class="status-message hidden">جارٍ الاتصال...</p>
            </div>
        </div>
    </div>
    
    <!-- رسالة الفوز -->
    <div id="winMessage" class="win-message">
        <h2 id="winnerText">مبروك! لقد فزت</h2>
        <p id="winScore">النتيجة النهائية: 10 - 5</p>
        <button id="playAgainBtn">العب مرة أخرى</button>
    </div>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD5UPSOqizEb5r6qo3SvzP1Jf86u_Yguoo",
            authDomain: "tennis-1f532.firebaseapp.com",
            databaseURL: "https://tennis-1f532-default-rtdb.firebaseio.com",
            projectId: "tennis-1f532",
            storageBucket: "tennis-1f532.appspot.com",
            messagingSenderId: "211499303707",
            appId: "1:211499303707:android:7aa9d5f52258da935209be"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // عناصر DOM
        const loginScreen = document.getElementById('loginScreen');
        const startScreen = document.getElementById('startScreen');
        const onlineScreen = document.getElementById('onlineScreen');
        const gameContainer = document.getElementById('gameContainer');
        const loginBtn = document.getElementById('loginBtn');
        const guestBtn = document.getElementById('guestBtn');
        const backToLoginBtn = document.getElementById('backToLoginBtn');
        const backToStartBtn = document.getElementById('backToStartBtn');
        const restartBtn = document.getElementById('restartBtn');
        const playAgainBtn = document.getElementById('playAgainBtn');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const winMessage = document.getElementById('winMessage');
        const winnerText = document.getElementById('winnerText');
        const winScore = document.getElementById('winScore');
        const playerNameElement = document.getElementById('playerName');
        const opponentNameElement = document.getElementById('opponentName');
        const leftScoreElement = document.getElementById('leftScore');
        const rightScoreElement = document.getElementById('rightScore');
        const onlineMenu = document.getElementById('onlineMenu');
        const roomInfo = document.getElementById('roomInfo');
        const roomIdDisplay = document.getElementById('roomIdDisplay');
        const roomStatus = document.getElementById('roomStatus');
        const hostName = document.getElementById('hostName');
        const guestName = document.getElementById('guestName');
        const hostStatus = document.getElementById('hostStatus');
        const guestStatus = document.getElementById('guestStatus');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const startOnlineGameBtn = document.getElementById('startOnlineGameBtn');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');
        const backToStartOnlineBtn = document.getElementById('backToStartOnlineBtn');
        const onlineStatus = document.getElementById('onlineStatus');
        const pingElement = document.getElementById('ping');
        const onlineStatusMessage = document.getElementById('onlineStatusMessage');
        const statusText = document.getElementById('statusText');
        const errorMessage = document.getElementById('errorMessage');
        const connectionStatus = document.getElementById('connectionStatus');
        
        // متغيرات اللعبة
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const paddleWidth = 12, paddleHeight = 100, ballSize = 12;
        let leftPaddleY = canvas.height / 2 - paddleHeight / 2;
        let rightPaddleY = canvas.height / 2 - paddleHeight / 2;
        let ballX = canvas.width / 2, ballY = canvas.height / 2;
        let ballSpeedX = 6, ballSpeedY = 4;
        let leftPaddleSpeed = 0;
        let rightPaddleSpeed = 0;
        let leftScore = 0, rightScore = 0;
        const winningScore = 5;
        let gameMode = 'single'; // single, multi, ai, online
        let playerName = "اللاعب";
        let opponentName = "الخصم";
        let gameRunning = false;
        
        // متغيرات الأونلاين
        let roomId = null;
        let isHost = false;
        let isOnlineGameActive = false;
        let playerRole = null; // 'left' or 'right'
        let lastPingTime = 0;
        let pingInterval = null;
        let gameStateRef = null;
        let roomRef = null;
        let playerMoveRef = null;
        let opponentMoveRef = null;

        // التحقق مما إذا كان الجهاز هاتفًا
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        // إدارة حالة الاتصال
        function showStatus(message) {
            statusText.textContent = message;
            onlineStatusMessage.classList.remove('hidden');
        }
        
        function hideStatus() {
            onlineStatusMessage.classList.add('hidden');
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }
        
        // أحداث التسجيل
        loginBtn.addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username && password) {
                playerName = username;
                loginScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            } else {
                showError('الرجاء إدخال اسم المستخدم وكلمة المرور');
            }
        });
        
        guestBtn.addEventListener('click', () => {
            playerName = "ضيف";
            loginScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });
        
        // أحداث التنقل بين الشاشات
        backToLoginBtn.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        });
        
        backToStartBtn.addEventListener('click', () => {
            if (gameMode === 'online') {
                leaveOnlineRoom();
            }
            gameContainer.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });
        
        backToStartOnlineBtn.addEventListener('click', () => {
            if (gameMode === 'online') {
                leaveOnlineRoom();
            }
            onlineScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });
        
        restartBtn.addEventListener('click', resetGame);
        playAgainBtn.addEventListener('click', () => {
            winMessage.classList.remove('show');
            resetGame();
        });
        
        // اختيار نمط اللعب
        modeButtons.forEach(button => {
            button.addEventListener('click', () => {
                gameMode = button.dataset.mode;
                
                if (gameMode === 'online') {
                    startScreen.classList.add('hidden');
                    onlineScreen.classList.remove('hidden');
                    onlineMenu.classList.remove('hidden');
                    roomInfo.classList.add('hidden');
                    return;
                }
                
                // تعيين أسماء حسب نمط اللعب
                if (gameMode === 'single') {
                    opponentName = "الذكاء الاصطناعي";
                } else if (gameMode === 'multi') {
                    opponentName = "اللاعب 2";
                } else {
                    playerName = "الذكاء الاصطناعي 1";
                    opponentName = "الذكاء الاصطناعي 2";
                }
                
                playerNameElement.textContent = playerName;
                opponentNameElement.textContent = opponentName;
                
                startScreen.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                resetGame();
            });
        });
        
        // أحداث الأونلاين
        createRoomBtn.addEventListener('click', createRoom);
        joinRoomBtn.addEventListener('click', joinRoom);
        startOnlineGameBtn.addEventListener('click', startOnlineGame);
        leaveRoomBtn.addEventListener('click', leaveOnlineRoom);
        
        // إنشاء غرفة جديدة
        function createRoom() {
            showStatus('جارٍ إنشاء الغرفة...');
            roomId = generateRoomId();
            isHost = true;
            playerRole = 'left';
            
            // إنشاء غرفة في Firebase
            roomRef = database.ref('rooms/' + roomId);
            roomRef.set({
                host: playerName,
                guest: null,
                status: 'waiting',
                hostReady: false,
                guestReady: false,
                createdAt: Date.now()
            }).then(() => {
                hideStatus();
                
                // تحديث واجهة المستخدم
                roomIdDisplay.textContent = roomId;
                roomStatus.textContent = "في انتظار اللاعب الثاني";
                hostName.textContent = playerName;
                hostStatus.textContent = "جاهز";
                guestName.textContent = "---";
                guestStatus.textContent = "في انتظار اللاعب";
                
                onlineMenu.classList.add('hidden');
                roomInfo.classList.remove('hidden');
                startOnlineGameBtn.classList.add('hidden');
                
                // الاستماع للتغييرات في الغرفة
                roomRef.on('value', (snapshot) => {
                    const roomData = snapshot.val();
                    if (!roomData) {
                        // تم حذف الغرفة
                        showError('تم حذف الغرفة من قبل المضيف');
                        leaveOnlineRoom();
                        return;
                    }
                    
                    if (roomData.guest) {
                        guestName.textContent = roomData.guest;
                        guestStatus.textContent = roomData.guestReady ? "جاهز" : "غير جاهز";
                        roomStatus.textContent = "اللاعبان متواجدان";
                        
                        if (roomData.guestReady) {
                            startOnlineGameBtn.classList.remove('hidden');
                        }
                    }
                    
                    if (roomData.status === 'playing') {
                        startOnlineGame();
                    }
                });
            }).catch((error) => {
                showError('فشل في إنشاء الغرفة: ' + error.message);
            });
        }
        
        // الانضمام إلى غرفة
        function joinRoom() {
            const roomIdInput = document.getElementById('roomId').value;
            if (!roomIdInput) {
                showError('الرجاء إدخال معرف الغرفة');
                return;
            }
            
            showStatus('جارٍ الانضمام إلى الغرفة...');
            roomId = roomIdInput;
            isHost = false;
            playerRole = 'right';
            
            roomRef = database.ref('rooms/' + roomId);
            
            roomRef.once('value').then((snapshot) => {
                const roomData = snapshot.val();
                if (!roomData) {
                    showError('لم يتم العثور على الغرفة');
                    return;
                }
                
                if (roomData.guest) {
                    showError('الغرفة ممتلئة بالفعل');
                    return;
                }
                
                // تحديث الغرفة ببيانات الضيف
                roomRef.update({
                    guest: playerName,
                    guestReady: false
                }).then(() => {
                    hideStatus();
                    
                    // تحديث واجهة المستخدم
                    roomIdDisplay.textContent = roomId;
                    roomStatus.textContent = "تم الانضمام للغرفة";
                    hostName.textContent = roomData.host;
                    hostStatus.textContent = roomData.hostReady ? "جاهز" : "غير جاهز";
                    guestName.textContent = playerName;
                    guestStatus.textContent = "جاهز";
                    
                    onlineMenu.classList.add('hidden');
                    roomInfo.classList.remove('hidden');
                    startOnlineGameBtn.classList.remove('hidden');
                    
                    // تحديث حالة الجاهزية
                    roomRef.update({ guestReady: true });
                    
                    // الاستماع للتغييرات في الغرفة
                    roomRef.on('value', (snapshot) => {
                        const updatedRoomData = snapshot.val();
                        if (!updatedRoomData) {
                            // تم حذف الغرفة
                            showError('تم حذف الغرفة من قبل المضيف');
                            leaveOnlineRoom();
                            return;
                        }
                        
                        hostStatus.textContent = updatedRoomData.hostReady ? "جاهز" : "غير جاهز";
                        
                        if (updatedRoomData.status === 'playing') {
                            startOnlineGame();
                        }
                    });
                }).catch((error) => {
                    showError('فشل في الانضمام إلى الغرفة: ' + error.message);
                });
            }).catch((error) => {
                showError('فشل في الاتصال: ' + error.message);
            });
        }
        
        // بدء لعبة الأونلاين
        function startOnlineGame() {
            if (!roomId) return;
            
            showStatus('جارٍ بدء اللعبة...');
            const roomRef = database.ref('rooms/' + roomId);
            
            // تحديث حالة الغرفة
            roomRef.update({
                status: 'playing',
                hostReady: true,
                guestReady: true
            }).then(() => {
                hideStatus();
                
                // إخفاء شاشة الغرفة وإظهار شاشة اللعبة
                onlineScreen.classList.add('hidden');
                gameContainer.classList.remove('hidden');
                onlineStatus.classList.remove('hidden');
                connectionStatus.classList.remove('hidden');
                
                // تعيين الأسماء
                playerNameElement.textContent = playerName;
                opponentNameElement.textContent = isHost ? guestName.textContent : hostName.textContent;
                
                // إعداد مرجع حالة اللعبة
                gameStateRef = database.ref('gameState/' + roomId);
                
                // إعداد مرجع حركة اللاعبين
                playerMoveRef = database.ref('playerMoves/' + roomId + '/' + playerRole);
                opponentMoveRef = database.ref('playerMoves/' + roomId + '/' + (playerRole === 'left' ? 'right' : 'left'));
                
                // إعادة ضبط اللعبة
                resetGame();
                isOnlineGameActive = true;
                
                // بدء قياس البنج
                startPing();
                
                // الاستماع لتحديثات حالة اللعبة
                if (isHost) {
                    // المضيف يتحكم بالكرة والحالة
                    gameStateRef.onDisconnect().remove();
                    
                    // إرسال الحالة الأولية
                    sendGameState();
                    
                    // الاستماع لتحركات الخصم (المضرب الأيمن فقط)
                    opponentMoveRef.on('value', (snapshot) => {
                        if (snapshot.exists()) {
                            rightPaddleY = snapshot.val();
                        }
                    });
                } else {
                    // الضيف يستقبل التحديثات
                    gameStateRef.on('value', (snapshot) => {
                        if (!snapshot.exists()) return;
                        
                        const gameState = snapshot.val();
                        
                        // تحديث حالة اللعبة المحلية
                        leftPaddleY = gameState.leftPaddleY;
                        ballX = gameState.ballX;
                        ballY = gameState.ballY;
                        ballSpeedX = gameState.ballSpeedX;
                        ballSpeedY = gameState.ballSpeedY;
                        leftScore = gameState.leftScore;
                        rightScore = gameState.rightScore;
                        
                        leftScoreElement.textContent = leftScore;
                        rightScoreElement.textContent = rightScore;
                        
                        // التحقق من الفوز
                        if (leftScore >= winningScore || rightScore >= winningScore) {
                            showWinMessage();
                        }
                    });
                }
            }).catch((error) => {
                showError('فشل في بدء اللعبة: ' + error.message);
            });
        }
        
        // إرسال حالة اللعبة (للمضيف فقط)
        function sendGameState() {
            if (isHost && gameStateRef) {
                gameStateRef.set({
                    leftPaddleY: leftPaddleY,
                    ballX: ballX,
                    ballY: ballY,
                    ballSpeedX: ballSpeedX,
                    ballSpeedY: ballSpeedY,
                    leftScore: leftScore,
                    rightScore: rightScore,
                    lastUpdate: Date.now()
                }).catch((error) => {
                    connectionStatus.textContent = 'خطأ في الاتصال: ' + error.message;
                });
            }
        }
        
        // مغادرة الغرفة
        function leaveOnlineRoom() {
            if (roomId) {
                if (roomRef) {
                    roomRef.off();
                    
                    if (isHost) {
                        // المضيف يزيل الغرفة بالكامل
                        roomRef.remove();
                    } else {
                        // الضيف يزيل نفسه فقط
                        roomRef.update({
                            guest: null,
                            guestReady: false
                        });
                    }
                }
                
                if (gameStateRef) {
                    gameStateRef.off();
                }
                
                if (playerMoveRef) {
                    playerMoveRef.off();
                    playerMoveRef = null;
                }
                
                if (opponentMoveRef) {
                    opponentMoveRef.off();
                    opponentMoveRef = null;
                }
                
                // إزالة بيانات التحركات
                if (roomId) {
                    database.ref('playerMoves/' + roomId).remove();
                }
                
                roomId = null;
            }
            
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
            
            onlineMenu.classList.remove('hidden');
            roomInfo.classList.add('hidden');
            gameContainer.classList.add('hidden');
            onlineScreen.classList.remove('hidden');
            isOnlineGameActive = false;
            connectionStatus.classList.add('hidden');
        }
        
        // بدء قياس البنج
        function startPing() {
            if (!isOnlineGameActive) return;
            
            lastPingTime = Date.now();
            pingInterval = setInterval(() => {
                const now = Date.now();
                const pingValue = Math.floor(now - lastPingTime);
pingElement.textContent = pingValue;
                lastPingTime = now;
                
            // تحديد حالة الاتصال بناءً على البنج
            if (pingValue < 100) {
                connectionStatus.textContent = 'الاتصال ممتاز';
                connectionStatus.style.color = '#4CAF50';
            } else if (pingValue < 200) {
                connectionStatus.textContent = 'الاتصال جيد';
                connectionStatus.style.color = '#FFC107';
            } else {
                connectionStatus.textContent = 'الاتصال ضعيف';
                connectionStatus.style.color = '#F44336';
            }
            
            // إرسال تحديث البنج
            if (gameStateRef && isHost) {
                gameStateRef.update({ ping: lastPingTime });
            }
        }, 1000);
    }
    
    // إنشاء معرف غرفة عشوائي
    function generateRoomId() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 6; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }
    
    // رسم العناصر
    function draw() {
        // الخلفية
        ctx.fillStyle = '#0d1b2a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // الخط المنقط في المنتصف
        ctx.beginPath();
        ctx.setLineDash([10, 15]);
        ctx.moveTo(canvas.width / 2, 0);
        ctx.lineTo(canvas.width / 2, canvas.height);
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.lineWidth = 4;
        ctx.stroke();
        ctx.setLineDash([]);
        
        // المضرب الأيسر (تدرج لوني مع حدود)
        const leftPaddleGradient = ctx.createLinearGradient(20, leftPaddleY, 20, leftPaddleY + paddleHeight);
        leftPaddleGradient.addColorStop(0, '#ff9800');
        leftPaddleGradient.addColorStop(1, '#f57c00');
        ctx.fillStyle = leftPaddleGradient;
        ctx.fillRect(20, leftPaddleY, paddleWidth, paddleHeight);
        ctx.strokeStyle = '#ff5722';
        ctx.lineWidth = 2;
        ctx.strokeRect(20, leftPaddleY, paddleWidth, paddleHeight);
        
        // المضرب الأيمن (تدرج لوني مع حدود)
        const rightPaddleGradient = ctx.createLinearGradient(
            canvas.width - 20 - paddleWidth, 
            rightPaddleY, 
            canvas.width - 20 - paddleWidth, 
            rightPaddleY + paddleHeight
        );
        rightPaddleGradient.addColorStop(0, '#2196f3');
        rightPaddleGradient.addColorStop(1, '#1976d2');
        ctx.fillStyle = rightPaddleGradient;
        ctx.fillRect(canvas.width - 20 - paddleWidth, rightPaddleY, paddleWidth, paddleHeight);
        ctx.strokeStyle = '#1565c0';
        ctx.lineWidth = 2;
        ctx.strokeRect(canvas.width - 20 - paddleWidth, rightPaddleY, paddleWidth, paddleHeight);
        
        // الكرة مع تأثير ثلاثي الأبعاد
        ctx.beginPath();
        ctx.arc(ballX, ballY, ballSize, 0, Math.PI * 2);
        const ballGradient = ctx.createRadialGradient(
            ballX - 3, ballY - 3, 0,
            ballX, ballY, ballSize
        );
        ballGradient.addColorStop(0, '#e91e63');
        ballGradient.addColorStop(1, '#c2185b');
        ctx.fillStyle = ballGradient;
        ctx.fill();
        ctx.closePath();
        
        // الظل تحت الكرة
        ctx.beginPath();
        ctx.ellipse(ballX, ballY + ballSize + 3, ballSize - 2, ballSize/3, 0, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.fill();
        ctx.closePath();
        
        // النقاط
        ctx.font = 'bold 40px Arial';
        ctx.fillStyle = '#ffcc00';
        ctx.textAlign = 'center';
        ctx.fillText(leftScore + ' - ' + rightScore, canvas.width / 2, 50);
    }
    
    // تحديث حالة اللعبة
    function update() {
        if (!gameRunning) return;
        
        // حركة الكرة (للمضيف فقط في الأونلاين)
        if (gameMode !== 'online' || isHost) {
            ballX += ballSpeedX;
            ballY += ballSpeedY;
            
            // ارتداد الكرة من الأعلى والأسفل
            if (ballY + ballSize > canvas.height || ballY - ballSize < 0) {
                ballSpeedY = -ballSpeedY;
            }
            
            // ارتداد الكرة من المضارب
            if (ballX - ballSize < 30 && ballY > leftPaddleY && ballY < leftPaddleY + paddleHeight) {
                const relativeY = (ballY - (leftPaddleY + paddleHeight / 2)) / (paddleHeight / 2);
                ballSpeedX = -ballSpeedX * 1.05;
                ballSpeedY = relativeY * 8;
            }
            
            if (ballX + ballSize > canvas.width - 30 && ballY > rightPaddleY && ballY < rightPaddleY + paddleHeight) {
                const relativeY = (ballY - (rightPaddleY + paddleHeight / 2)) / (paddleHeight / 2);
                ballSpeedX = -ballSpeedX * 1.05;
                ballSpeedY = relativeY * 8;
            }
            
            // تسجيل النقاط
            if (ballX - ballSize < 0) {
                rightScore++;
                rightScoreElement.textContent = rightScore;
                resetBall();
            }
            
            if (ballX + ballSize > canvas.width) {
                leftScore++;
                leftScoreElement.textContent = leftScore;
                resetBall();
            }
        }
        
        // تحريك المضارب
        leftPaddleY += leftPaddleSpeed;
        rightPaddleY += rightPaddleSpeed;
        
        // منع المضارب من الخروج من الشاشة
        if (leftPaddleY < 0) leftPaddleY = 0;
        if (leftPaddleY + paddleHeight > canvas.height) leftPaddleY = canvas.height - paddleHeight;
        
        if (rightPaddleY < 0) rightPaddleY = 0;
        if (rightPaddleY + paddleHeight > canvas.height) rightPaddleY = canvas.height - paddleHeight;
        
        // إرسال تحركات اللاعب للأونلاين
        if (gameMode === 'online' && playerMoveRef) {
            if (playerRole === 'left') {
                playerMoveRef.set(leftPaddleY);
            } else {
                playerMoveRef.set(rightPaddleY);
            }
        }
        
        // الذكاء الاصطناعي (للعبة المحلية فقط)
        if (gameMode === 'single' || gameMode === 'ai') {
            // الذكاء الاصطناعي للمضرب الأيمن (الخصم)
            const aiPaddleCenter = rightPaddleY + paddleHeight / 2;
            const ballCenter = ballY;
            const reactionThreshold = 0.3; // يتحرك فقط إذا كانت الكرة قريبة
            
            if (ballSpeedX > 0) { // الكرة تتحرك نحو الخصم
                if (aiPaddleCenter < ballCenter - paddleHeight * reactionThreshold) {
                    rightPaddleY += 6;
                } else if (aiPaddleCenter > ballCenter + paddleHeight * reactionThreshold) {
                    rightPaddleY -= 6;
                }
            } else {
                // العودة إلى المركز عندما لا تكون الكرة قادمة
                const center = canvas.height / 2 - paddleHeight / 2;
                if (rightPaddleY < center) {
                    rightPaddleY += 3;
                } else if (rightPaddleY > center) {
                    rightPaddleY -= 3;
                }
            }
        }
        
        if (gameMode === 'ai') {
            // الذكاء الاصطناعي للمضرب الأيسر (اللاعب)
            const aiPaddleCenter = leftPaddleY + paddleHeight / 2;
            const ballCenter = ballY;
            const reactionThreshold = 0.3;
            
            if (ballSpeedX < 0) { // الكرة تتحرك نحو اللاعب
                if (aiPaddleCenter < ballCenter - paddleHeight * reactionThreshold) {
                    leftPaddleY += 6;
                } else if (aiPaddleCenter > ballCenter + paddleHeight * reactionThreshold) {
                    leftPaddleY -= 6;
                }
            } else {
                // العودة إلى المركز
                const center = canvas.height / 2 - paddleHeight / 2;
                if (leftPaddleY < center) {
                    leftPaddleY += 3;
                } else if (leftPaddleY > center) {
                    leftPaddleY -= 3;
                }
            }
        }
        
        // مزامنة حالة اللعبة للأونلاين (المضيف فقط)
        if (gameMode === 'online' && isHost && gameStateRef) {
            sendGameState();
        }
        
        // التحقق من الفوز
        if (leftScore >= winningScore || rightScore >= winningScore) {
            gameRunning = false;
            showWinMessage();
        }
    }
    
    // إعادة ضبط الكرة
    function resetBall() {
        ballX = canvas.width / 2;
        ballY = canvas.height / 2;
        
        // اتجاه عشوائي للكرة
        ballSpeedX = (Math.random() > 0.5 ? 1 : -1) * 6;
        ballSpeedY = (Math.random() * 4 - 2);
    }
    
    // إعادة ضبط اللعبة
    function resetGame() {
        leftScore = 0;
        rightScore = 0;
        leftScoreElement.textContent = leftScore;
        rightScoreElement.textContent = rightScore;
        
        leftPaddleY = canvas.height / 2 - paddleHeight / 2;
        rightPaddleY = canvas.height / 2 - paddleHeight / 2;
        
        resetBall();
        gameRunning = true;
        
        // إرسال الحالة الجديدة للأونلاين
        if (gameMode === 'online' && isHost && gameStateRef) {
            sendGameState();
        }
    }
    
    // عرض رسالة الفوز
    function showWinMessage() {
        if (leftScore >= winningScore) {
            winnerText.textContent = `مبروك! ${playerName} فاز`;
            winnerText.style.color = '#ff9800';
        } else {
            winnerText.textContent = `${opponentName} فاز`;
            winnerText.style.color = '#2196f3';
        }
        
        winScore.textContent = `النتيجة النهائية: ${leftScore} - ${rightScore}`;
        winMessage.classList.add('show');
        
        // إيقاف اللعبة
        gameRunning = false;
    }
    
    // حلقة اللعبة الرئيسية
    function gameLoop() {
        draw();
        update();
        requestAnimationFrame(gameLoop);
    }
    
    // أحداث لوحة المفاتيح
    document.addEventListener('keydown', function(event) {
        // التحكم بالمضرب الأيسر (اللاعب)
        if (gameMode !== 'online' || playerRole === 'left') {
            if (event.key === 'ArrowUp') {
                leftPaddleSpeed = -8;
            } else if (event.key === 'ArrowDown') {
                leftPaddleSpeed = 8;
            }
        }
        
        // التحكم بالمضرب الأيمن (في وضع اللاعبين أو الأونلاين)
        if (gameMode === 'multi' || (gameMode === 'online' && playerRole === 'right')) {
            if (event.key === 'w' || event.key === 'W') {
                rightPaddleSpeed = -8;
            } else if (event.key === 's' || event.key === 'S') {
                rightPaddleSpeed = 8;
            }
        }
    });
    
    document.addEventListener('keyup', function(event) {
        if (gameMode !== 'online' || playerRole === 'left') {
            if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                leftPaddleSpeed = 0;
            }
        }
        
        if (gameMode === 'multi' || (gameMode === 'online' && playerRole === 'right')) {
            if (event.key === 'w' || event.key === 'W' || event.key === 's' || event.key === 'S') {
                rightPaddleSpeed = 0;
            }
        }
    });
    
    // إضافة أزرار التحكم باللمس للهواتف
    if (isMobile) {
        const touchControls = document.createElement('div');
        touchControls.id = 'touchControls';
        touchControls.innerHTML = `
            <button id="upBtn" class="touch-btn">▲</button>
            <button id="downBtn" class="touch-btn">▼</button>
        `;
        document.body.appendChild(touchControls);
        
        const upBtn = document.getElementById('upBtn');
        const downBtn = document.getElementById('downBtn');
        
        // التحكم بالمضرب الأيسر
        if (gameMode !== 'online' || playerRole === 'left') {
            upBtn.addEventListener('touchstart', () => leftPaddleSpeed = -8);
            upBtn.addEventListener('touchend', () => leftPaddleSpeed = 0);
            downBtn.addEventListener('touchstart', () => leftPaddleSpeed = 8);
            downBtn.addEventListener('touchend', () => leftPaddleSpeed = 0);
        }
        
        // التحكم بالمضرب الأيمن
        if (gameMode === 'multi' || (gameMode === 'online' && playerRole === 'right')) {
            upBtn.addEventListener('touchstart', () => rightPaddleSpeed = -8);
            upBtn.addEventListener('touchend', () => rightPaddleSpeed = 0);
            downBtn.addEventListener('touchstart', () => rightPaddleSpeed = 8);
            downBtn.addEventListener('touchend', () => rightPaddleSpeed = 0);
        }
        
        // إظهار أزرار التحكم عند بدء اللعبة
        gameContainer.addEventListener('DOMNodeInserted', () => {
            if (gameContainer.classList.contains('hidden')) {
                touchControls.style.display = 'none';
            } else {
                touchControls.style.display = 'block';
            }
        });
    }
    
    // تنظيف عند إغلاق الصفحة
    window.addEventListener('beforeunload', function() {
        if (gameMode === 'online') {
            leaveOnlineRoom();
        }
    });
    
    // بدء حلقة اللعبة
    gameLoop();
</script>
</body>
</html>